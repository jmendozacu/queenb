var MagecheckoutSecuredCheckout=Class.create();MagecheckoutSecuredCheckout.prototype={initialize:function(){this.blocks={},this.queueBlocks={},this.currentRequest="",this.queueRequest=[],this.initAjaxResponse()},setConfig:function(e){this.blockMapping=e.blockMapping,this.loadingClass=e.loadingClass,this.showNumber=e.showNumber,this.actionPattern=e.actionPattern,this.isUsedMorphEffect=e.isUsedMorphEffect,this.saveFormUrl=e.saveFormUrl},setActionPattern:function(e){this.actionPattern=e},initAjaxResponse:function(){Ajax.Responders.register({onComplete:function(e){403===e.transport.status&&document.location.reload()}})},setBlocks:function(e){$H(e.blocks).each(function(e){this._addBlock(e[0],e[1])}.bind(this))},_addBlock:function(e,t){"undefined"==typeof this.blocks[e]&&$$(t).each(function(t){this.blocks[e]=t}.bind(this))},saveFormData:function(e){var t=Form.serialize(e,!0),i={method:"post",parameters:t};new Ajax.Request(this.saveFormUrl,i)},applyMorphEffect:function(e,t,i,s){if(this.isUsedMorphEffect){e.effect&&e.effect.cancel();var s=s||Prototype.emptyFunction;e.effect=new Effect.Morph(e,{style:{height:t+"px"},duration:i,afterFinish:function(){delete e.effect,s()}})}else e.setStyle(0===t?{display:"none",height:0}:{height:"",display:""})},getHeightFromElement:function(e){var t=e.style.height,i=e.style.visibility,s=e.style.display;e=this.resetElement(e);var o=e.getHeight();return e.setStyle({display:s,visibility:i,height:t}),o},resetElement:function(e){return e.setStyle({height:"",display:"",visibility:"hidden"}),e},showMessage:function(e,t,i){"object"==typeof t&&t.length>0?t.each(function(t){this._appendMessage(e,t,i)}.bind(this)):"string"==typeof t&&this._appendMessage(e,t,i)},removeMessage:function(e,t){e.select("."+t).each(function(e){e.remove()})},_appendMessage:function(e,t,i){var s=null,o=e.select("."+i+" ol");if(0===o.length){var n=new Element("div");n.addClassName(i),n.appendChild(new Element("ol")),e.insertBefore(n,e.down()),s=n.down()}else s=o.first();var r=new Element("li");r.update(t),s.appendChild(r)},addOverlay:function(e,t){var i=new Element("div");i.addClassName(t),e.appendChild(i)},removeOverlay:function(e,t){e.select("."+t).each(function(e){e.remove()})},Request:function(e,t){var i=this._getActionFromUrl(e,this.actionPattern);this.addBlocksToQueue(i),""===this.currentRequest?this.newRequest(e,t):this.queueRequest.push([e,t])},newRequest:function(e,t){var i=this._getActionFromUrl(e,this.actionPattern),t=t||{},s=Object.extend({},t),o=this;s=Object.extend(s,{onComplete:function(e){o.onComplete(e,i),t.onComplete&&t.onComplete(e)}}),this.currentRequest=new Ajax.Request(e,s)},reRequest:function(e,t){this.newRequest(e,t)},_getActionFromUrl:function(e,t){var i=e.match(t);return i&&i[1]?i[1]:null},addBlocksToQueue:function(e){e&&this.blockMapping[e]&&this.blockMapping[e].each(function(e){if("undefined"==typeof this.queueBlocks[e]&&(this.queueBlocks[e]=0),this.blocks[e]){if(0===this.queueBlocks[e]){var t=this.blocks[e];"appendQueueBeforeFinish"in this.blocks[e]&&this.blocks[e].appendQueueBeforeFinish(),this.appendLoading(t),"appendQueueAfterFinish"in this.blocks[e]&&this.blocks[e].appendQueueAfterFinish()}this.queueBlocks[e]++}}.bind(this))},appendLoading:function(e,t){var i=t;i||(i=this.loadingClass),e.setStyle({position:"relative"});var s=new Element("div");s.addClassName(i),e.insertBefore(s,e.down())},onComplete:function(transport,action){try{eval("var response = "+transport.responseText)}catch(e){var response={blocks:{}}}if(this.removeBlockQueue(action,response),this.currentRequest="",this.queueRequest.length>0){this._emptyQueue();var args=this.queueRequest.shift();this.reRequest(args[0],args[1])}},removeBlockQueue:function(e,t){if(e&&this.blockMapping[e]){var t=t||{},i=t.blocks||{};this.blockMapping[e].each(function(e){this.blocks[e]&&(this.queueBlocks[e]--,0===this.queueBlocks[e]&&(i[e]&&this.blocks[e].update(i[e]),"removeQueueBeforeFinish"in this.blocks[e]&&this.blocks[e].removeQueueBeforeFinish(t),this.updateNumbers(),this.removeLoading(this.blocks[e]),"removeQueueAfterFinish"in this.blocks[e]&&this.blocks[e].removeQueueAfterFinish(t)))}.bind(this))}},removeLoading:function(e,t){var i=t;i||(i=this.loadingClass);var s="."+i;e.setStyle({position:""}),e.select(s).each(function(e){e.remove()})},_emptyQueue:function(){var e=[],t=[];this.queueRequest.reverse().each(function(i,s){var o=this._getActionFromUrl(i[0],this.actionPattern);-1===e.indexOf(o)?e.push(o):t.push(s)}.bind(this));var i=[];this.queueRequest.each(function(e,s){var o=this._getActionFromUrl(e[0],this.actionPattern);-1===t.indexOf(s)?i.push(e):this.removeBlockQueue(o)}.bind(this)),this.queueRequest=i.reverse()},updateNumbers:function(){if(this.showNumber){var e=1;$$(".one-step-checkout-number").each(function(t){return 0===t.up().getHeight()||t.next()&&0===t.next().getHeight()?!1:(t.update(e),void e++)})}}};var MagecheckoutSecuredCheckoutPopup=Class.create();MagecheckoutSecuredCheckoutPopup.prototype={initialize:function(e){this.selector=$$(e.selector).first(),this.tinyBoxConfig=e.tinyBoxConfig,this.initObserver()},initObserver:function(){this.selector&&this.selector.observe("click",function(){this.showPopup()}.bind(this))},showPopup:function(){"object"==typeof this.tinyBoxConfig.html&&this.tinyBoxConfig.html.setStyle({display:""}),TINY2.box.show(this.tinyBoxConfig)},hidePopup:function(){TINY2.box.hide()}};var MagecheckoutSecuredCheckoutAuthentication=Class.create();MagecheckoutSecuredCheckoutAuthentication.prototype={initialize:function(e){this.popupContainer=$(e.popupContainer),this.loginContainer=$(e.loginContainer),this.forgotContainer=$(e.forgotContainer),this.forgotLink=$(e.forgotLink),this.backLink=$(e.backLink),this.loginUrl=e.loginUrl,this.forgotUrl=e.forgotUrl,this.loginSubmitBtn=$(e.loginSubmitBtn),this.forgotSubmitBtn=$(e.forgotSubmitBtn),this.loadingClass=e.loadingClass,this.errorClass=e.errorClass,this.successClass=e.successClass,this.mode="form_login",this.initObserver()},initObserver:function(){this.forgotLink.observe("click",function(){this.loginContainer.hide(),this.forgotContainer.show(),this.mode="form_forgot"}.bind(this)),this.backLink.observe("click",function(){this.forgotContainer.hide(),this.loginContainer.show(),this.mode="form_login"}.bind(this)),this.loginSubmitBtn.observe("click",function(){this._processLogin()}.bind(this)),this.forgotSubmitBtn.observe("click",function(){this._processForgotPw()}.bind(this)),document.observe("keypress",this.keypressHandler.bind(this))},keypressHandler:function(e){var t=e.keyCode||e.which;return 13==t?void("form_login"==this.mode?this._processLogin():"form_forgot"==this.mode&&this._processForgotPw()):void 0},_processLogin:function(){var e=this,t=this.loginContainer.down("form"),i=this.successClass,s=this.errorClass;if(t.validator=new Validation(t),t.select(".validation-advice").each(function(e){e.remove()}),t.validator.validate()){this._removeAllMessage(),MagecheckoutSecuredCheckout.appendLoading(t,this.loadingClass);var o={parameters:t.serialize(!0),onComplete:function(o){try{var n=o.responseText.evalJSON();n.success===!0?(MagecheckoutSecuredCheckout.showMessage(t,n.message,i),document.location.reload()):n.error&&(MagecheckoutSecuredCheckout.removeLoading(t,e.loadingClass),MagecheckoutSecuredCheckout.showMessage(t,n.error,s))}catch(r){}}};MagecheckoutSecuredCheckout.Request(this.loginUrl,o)}},_processForgotPw:function(){var e=this.forgotContainer.down("form"),t=this.successClass,i=this.errorClass;if(e.validator=new Validation(e),e.select(".validation-advice").each(function(e){e.remove()}),e.validator.validate()){this._removeAllMessage(),MagecheckoutSecuredCheckout.appendLoading(e);var s={parameters:e.serialize(!0),onComplete:function(s){try{var o=s.responseText.evalJSON();o.success===!0?MagecheckoutSecuredCheckout.showMessage(e,o.message,t):o.error&&MagecheckoutSecuredCheckout.showMessage(e,o.error,i),MagecheckoutSecuredCheckout.removeLoading(e)}catch(n){}}};MagecheckoutSecuredCheckout.Request(this.forgotUrl,s)}},_removeAllMessage:function(){MagecheckoutSecuredCheckout.removeMessage(this.loginContainer,this.errorClass),MagecheckoutSecuredCheckout.removeMessage(this.loginContainer,this.successClass),MagecheckoutSecuredCheckout.removeMessage(this.forgotContainer,this.errorClass),MagecheckoutSecuredCheckout.removeMessage(this.forgotContainer,this.successClass)}};var MagecheckoutSecuredCheckoutAddress=Class.create();MagecheckoutSecuredCheckoutAddress.prototype={initialize:function(e){this.addressContainer=$$(e.addressContainer).first(),this.saveAddressUrl=e.saveAddressUrl,this.billingAddress={},this.billingAddress.countryRegionData={},this.shippingAddress={},this.shippingAddress.countryRegionData={}},setBillingAddress:function(e){this.billingAddress.container=$$(e.container).first(),this.billingAddress.addressSelect=$$(e.addressSelect).first(),this.billingAddress.newAddressContainer=$$(e.newAddressContainer).first(),this.billingAddress.createAccountCheckbox=$$(e.createAccountCheckbox).first(),this.billingAddress.passwordContainer=$$(e.passwordContainer).first(),this.billingAddress.useSameAddressCheckbox=$$(e.useSameAddressCheckbox).first(),this.billingAddress.triggerElements=e.triggerElements,this.billingAddress.countryRegionElements=e.countryRegionElements,this.billingAddress.countrySelect=$(this.billingAddress.countryRegionElements.countrySelect),this.billingAddress.regionSelect=$(this.billingAddress.countryRegionElements.regionSelect),this.billingAddress.regionInput=$(this.billingAddress.countryRegionElements.regionInput)},setShippingAddress:function(e){this.shippingAddress.container=$$(e.container).first(),this.shippingAddress.addressSelect=$$(e.addressSelect).first(),this.shippingAddress.newAddressContainer=$$(e.newAddressContainer).first(),this.shippingAddress.triggerElements=e.triggerElements,this.shippingAddress.countryRegionElements=e.countryRegionElements,this.shippingAddress.countrySelect=$(this.billingAddress.countryRegionElements.countrySelect),this.shippingAddress.regionSelect=$(this.billingAddress.countryRegionElements.regionSelect),this.shippingAddress.regionInput=$(this.billingAddress.countryRegionElements.regionInput)},initAddress:function(){this._sameAddressProcess(this.billingAddress.useSameAddressCheckbox),this._processAddressSelect(this.billingAddress),this._processAddressSelect(this.shippingAddress)},initObserver:function(){var e=this.billingAddress.useSameAddressCheckbox,t=this.billingAddress.createAccountCheckbox,i=this.billingAddress.countrySelect,s=this.billingAddress.regionSelect,o=this.billingAddress.regionInput,n=this.billingAddress.triggerElements,r=this.billingAddress.addressSelect;e&&e.observe("change",function(e){this._sameAddressProcess(e),this.changeAddressFinish(),this._processAddressSelect(this.shippingAddress)}.bind(this)),t&&t.observe("change",function(e){this._createAccountProcess(e)}.bind(this)),i&&i.observe("change",function(){this.countrySelectChanged(this.billingAddress)}.bind(this)),s&&s.observe("change",function(){this.regionSelectChanged(this.billingAddress)}.bind(this)),o&&o.observe("change",function(){this.regionInputChanged(this.billingAddress)}.bind(this)),n&&n.each(function(e){var t=$(e);t&&t.observe("change",function(){this.triggerElementChanged(this.billingAddress)}.bind(this))}.bind(this)),r&&r.observe("change",function(){this._processAddressSelect(this.billingAddress),this.changeAddressFinish()}.bind(this));var c=this.shippingAddress.countrySelect,a=this.shippingAddress.regionSelect,h=this.shippingAddress.regionInput,d=this.shippingAddress.triggerElements,u=this.shippingAddress.addressSelect;c&&c.observe("change",function(){this.countrySelectChanged(this.shippingAddress)}.bind(this)),a&&a.observe("change",function(){this.regionSelectChanged(this.shippingAddress)}.bind(this)),h&&h.observe("change",function(){this.regionInputChanged(this.shippingAddress)}.bind(this)),d&&d.each(function(e){var t=$(e);t&&t.observe("change",function(){this.triggerElementChanged(this.shippingAddress)}.bind(this))}.bind(this)),u&&u.observe("change",function(){this._processAddressSelect(this.shippingAddress),this.changeAddressFinish()}.bind(this)),Form.getElements(this.addressContainer).each(function(e){var t=e.id;return e===this.billingAddress.useSameAddressCheckbox||-1!==this.billingAddress.triggerElements.indexOf(t)||-1!==this.shippingAddress.triggerElements.indexOf(t)?!1:void e.observe("change",function(){this.saveFormData()}.bind(this))}.bind(this))},_sameAddressProcess:function(e){if("object"==typeof e){var t=!1;t=e.target?e.target.checked:e.checked,t?this.hideShippingAddress():this.showShippingAddress()}},_createAccountProcess:function(e){if("object"==typeof e){var t=!1;t=e.target?e.target.checked:e.checked,t?this.showPasswordContainer():this.hidePasswordContainer()}},showPasswordContainer:function(){var e=this.billingAddress.passwordContainer;e.setStyle({display:""});var t=MagecheckoutSecuredCheckout.getHeightFromElement(e);MagecheckoutSecuredCheckout.applyMorphEffect(e,t,.3,function(){e.setStyle({height:""})})},hidePasswordContainer:function(){var e=this.billingAddress.passwordContainer;MagecheckoutSecuredCheckout.applyMorphEffect(e,0,.5,function(){e.setStyle({display:"none"})})},changeAddressFinish:function(){var e={},t="",i="";this.billingAddress.container&&(t=Form.serialize(this.billingAddress.container,!0)),this.shippingAddress.container&&(i=Form.serialize(this.shippingAddress.container,!0)),t&&(e=Object.extend(e,t)),i&&(e=Object.extend(e,i));var s={method:"post",parameters:e};MagecheckoutSecuredCheckout.Request(this.saveAddressUrl,s)},showShippingAddress:function(){var e=this.shippingAddress.container;e.setStyle({display:""});var t=MagecheckoutSecuredCheckout.getHeightFromElement(e);MagecheckoutSecuredCheckout.applyMorphEffect(e,t,.3,function(){e.setStyle({height:""}),MagecheckoutSecuredCheckout.updateNumbers()})},hideShippingAddress:function(){var e=this.shippingAddress.container;MagecheckoutSecuredCheckout.applyMorphEffect(e,0,.5,function(){e.setStyle({display:"none"}),MagecheckoutSecuredCheckout.updateNumbers()})},countrySelectChanged:function(e){var t=e.countryRegionData[e.countrySelect.getValue()];t&&("regionSelect"===t.type?e.regionSelect.setValue(t.value):e.regionInput.setValue(t.value))},regionSelectChanged:function(e){e.countryRegionData[e.countrySelect.getValue()]={type:"regionSelect",value:e.regionSelect.getValue()}},regionInputChanged:function(e){e.countryRegionData[e.countrySelect.getValue()]={type:"regionInput",value:e.regionInput.getValue()}},triggerElementChanged:function(e){var t=this,i=e.triggerElements.all(function(e){var i=$(e);return i?t.validateElement(i):void 0},this);i&&this.changeAddressFinish()},validateElement:function(e){var t=$w(e.className),i=!0;return t.all(function(t){var s=Validation.get(t);try{i=Validation.isVisible(e)&&!s.test($F(e),e)?!1:!0}catch(o){i=!0}}),i},_processAddressSelect:function(e){e.addressSelect&&(e.addressSelect.value?this.hideNewAddressContainer(e):this.showNewAddressContainer(e))},showNewAddressContainer:function(e){var t=e.newAddressContainer;t.setStyle({display:""});var i=MagecheckoutSecuredCheckout.getHeightFromElement(t);MagecheckoutSecuredCheckout.applyMorphEffect(t,i,.3,function(){e.container.setStyle({height:""})}.bind(this))},hideNewAddressContainer:function(e){var t=e.newAddressContainer;MagecheckoutSecuredCheckout.applyMorphEffect(t,0,.5,function(){t.setStyle({display:"none"})}.bind(this))},saveFormData:function(){MagecheckoutSecuredCheckout.saveFormData(this.addressContainer)}},MagecheckoutSecuredCheckoutAddressDetect=Class.create(),MagecheckoutSecuredCheckoutAddressDetect.prototype={initialize:function(e){this.inputSelector=$(e.inputSelector),this.componentForm=e.componentForm,this.addressType=e.addressType,this.addressElementsIds=e.addressElementsIds,this.regionUpdater=e.regionUpdater,this.securedCheckoutAddress=e.securedCheckoutAddress,this.geolocation=$(e.geolocation),this.specificCountry=e.specificCountry,this.initGoogleAutoComplete()},initGoogleAutoComplete:function(){var e=this;if(this.inputSelector){var t={types:["geocode"]};if(this.specificCountry){var i={componentRestrictions:{country:this.specificCountry}};t=Object.extend(t,i)}this.googleAutoComplete=new google.maps.places.Autocomplete(this.inputSelector,t),google.maps.event.addListener(this.googleAutoComplete,"place_changed",function(){e.googleResponse(e.googleAutoComplete.getPlace())})}this.geolocation&&this.geolocation.observe("click",function(){this.geoLocate()}.bind(this))},googleResponse:function(e){for(var t,i,s,o,n,r,c=0;c<e.address_components.length;c++){var a=e.address_components[c].types[0];this.componentForm[a]&&("street_number"==a&&(t&&e.address_components[c][this.componentForm.street_number]?t+=", "+e.address_components[c][this.componentForm.street_number]:t=e.address_components[c][this.componentForm.street_number]),"route"==a&&(t&&e.address_components[c][this.componentForm.route]?t+=" "+e.address_components[c][this.componentForm.route]:t=e.address_components[c][this.componentForm.route]),"neighborhood"==a&&(t&&e.address_components[c][this.componentForm.neighborhood]?t+=", "+e.address_components[c][this.componentForm.neighborhood]:t=e.address_components[c][this.componentForm.neighborhood]),"administrative_area_level_2"==a&&(t&&e.address_components[c][this.componentForm.administrative_area_level_2]?t+=", "+e.address_components[c][this.componentForm.administrative_area_level_2]:t=e.address_components[c][this.componentForm.administrative_area_level_2]),"locality"==a&&(i=e.address_components[c][this.componentForm.locality]),"administrative_area_level_1"==a&&(s=e.address_components[c].short_name,o=e.address_components[c].long_name),"country"==a&&(n=e.address_components[c][this.componentForm.country]),"postal_code"==a&&(r=e.address_components[c][this.componentForm.postal_code]))}this.responseComponents={street1:t,city:i,region_id:s,region:o,country_id:n,postcode:r},this.fillAddressById()},fillAddressById:function(){var e=this,t=this.securedCheckoutAddress.billingAddress,i=this.securedCheckoutAddress.shippingAddress;this.addressElementsIds.each(function(t){var i=$(e.addressType+":"+t);i&&e.responseComponents[t]&&(i.value=e.responseComponents[t])}),this.regionUpdater&&this.regionUpdater.update(),this.securedCheckoutAddress.triggerElementChanged("billing"==this.addressType?t:i)},geoLocate:function(){if(navigator.geolocation){var e=this;navigator.geolocation.getCurrentPosition(function(t){e.getAddressBytLatitude(t.coords.latitude,t.coords.longitude)})}},getAddressBytLatitude:function(e,t){var i=this,s=new google.maps.Geocoder,o=new google.maps.LatLng(e,t);s.geocode({latLng:o},function(e,t){return t!=google.maps.GeocoderStatus.OK?!1:void i.googleResponse(e[0])})}},MagecheckoutSecuredCheckoutShippingMethod=Class.create(),MagecheckoutSecuredCheckoutShippingMethod.prototype={initialize:function(e){this.shipingMethodContainer=$$(e.shipingMethodContainer).first(),this.shippingMethodElements=$$(e.shippingMethodElements),this.shippingMethodAdvice=$$(e.shippingMethodAdvice).first(),this.saveShippingMethodUrl=e.saveShippingMethodUrl,window.shippingMethod={},window.shippingMethod.validator=null,this.initObserver()},initObserver:function(){this.shippingMethodElements.each(function(e){e.observe("click",function(){this.removeValidationAdvice(),this.saveShippingMethod(e.value)}.bind(this))}.bind(this))},saveShippingMethod:function(e){if(this.currentMethod!==e){var t=Form.serialize(this.shipingMethodContainer,!0);MagecheckoutSecuredCheckout.Request(this.saveShippingMethodUrl,{method:"post",parameters:t}),this.currentMethod=e}},removeValidationAdvice:function(){this.shippingMethodAdvice&&this.shippingMethodAdvice.update("").hide()}},MagecheckoutSecuredCheckoutPaymentMethod=Class.create(),MagecheckoutSecuredCheckoutPaymentMethod.prototype={initialize:function(e){this.paymentMethodContainer=$$(e.paymentMethodContainer).first(),this.paymentMethodWrapper=$$(e.paymentMethodWrapper).first(),this.paymentMethodElements=$$(e.paymentMethodElements),this.paymentMethodAdvice=$$(e.paymentMethodAdvice).first(),this.savePaymentMethodUrl=e.savePaymentMethodUrl,this.cvv={container:$$(e.cvv.container).first(),showEl:$$(e.cvv.showEl).first(),hideEl:$$(e.cvv.hideEl).first()},this.initPayment(),this.initObserver()},initPayment:function(){this.paymentMethodElements.each(function(e){var t=e.value,i=$("payment_form_"+t);i&&i.setStyle({overflow:"hidden",display:"none"}),e.checked?(this.changeVisible(t,!1),this.currentMethod=t):this.changeVisible(t,!0)}.bind(this))},initObserver:function(){var e=this;this.paymentMethodElements.each(function(t){t.observe("click",function(){this.removeValidationAdvice(),this.switchMethod(t.value)}.bind(this));var i="payment_form_"+t.value;[i+"_before",i,i+"_after"].each(function(t){var i=$(t);i&&Form.getElements(i).each(function(t){t.observe("change",function(){e.savePaymentMethod(),Validation.reset(t)})}.bind(this))})}.bind(this));var t=this.cvv.showEl,i=this.cvv.hideEl;t&&t.observe("click",function(e){this.toogleCvvTooltip(e,!0)}.bind(this)),i&&i.observe("click",function(e){this.toogleCvvTooltip(e,!1)}.bind(this)),this.paymentMethodWrapper.appendQueueAfterFinish||(this.paymentMethodWrapper.appendQueueAfterFinish=function(){this.storeValues={},Form.getElements(this.paymentMethodWrapper).each(function(e){var t=e.id;t in this.storeValues&&e.setValue(this.storeValues[t])}.bind(this))}.bind(this)),this.paymentMethodWrapper.removeQueueAfterFinish||(this.paymentMethodWrapper.removeQueueAfterFinish=function(){Form.getElements(this.paymentMethodWrapper).each(function(e){var t=e.id;t in this.storeValues&&e.setValue(this.storeValues[t])}.bind(this)),this.storeValues={}}.bind(this))},removeValidationAdvice:function(){this.paymentMethodAdvice&&this.paymentMethodAdvice.update("").hide()},toogleCvvTooltip:function(e,t){this.cvv.container&&this.cvv.container.setStyle(t?{display:"",top:Event.pointerY(e)+40+"px"}:{display:"none"}),e.stop()},switchMethod:function(e){var t=!0;if("customercredit"===e){t=!1;var i=$("p_method_customercredit");i&&i.checked||(e="")}t&&this.currentMethod&&$("payment_form_"+this.currentMethod+"_preencrypt")&&this.changeVisible(this.currentMethod+"_preencrypt",!0),t&&this.currentMethod&&$("payment_form_"+this.currentMethod)&&this.changeVisible(this.currentMethod,!0),$("payment_form_"+e)||$("payment_form_"+e+"_preencrypt")?$("payment_form_"+e)?this.changeVisible(e,!1):this.changeVisible(e+"_preencrypt",!1):$(document.body).fire("payment-method:switched",{method_code:e}),t&&(this.currentMethod=e),this.savePaymentMethod(),"undefined"!=typeof MultiFees&&MultiFees.showPayment()},changeVisible:function(e,t){var i="payment_form_"+e;[i+"_before",i,i+"_after"].each(function(e){var i=$(e);if(i){if(i.setStyle({overflow:"hidden"}),t)MagecheckoutSecuredCheckout.applyMorphEffect(i,0,.5,function(){i.setStyle({display:"none"})});else{i.setStyle({display:"",height:"0px"});var s=MagecheckoutSecuredCheckout.getHeightFromElement(i);MagecheckoutSecuredCheckout.applyMorphEffect(i,s,.3,function(){i.setStyle({height:""})})}i.select("input","select","textarea","button").each(function(e){e.disabled=t})}})},savePaymentMethod:function(){var e=!0,t="payment_form_"+this.currentMethod;if([t+"_before",t,t+"_after"].each(function(t){var i=$(t);i&&(e=this.validateElement(i))}.bind(this)),e){window.payment.currentMethod=this.currentMethod;var i=Form.serialize(this.paymentMethodContainer,!0);MagecheckoutSecuredCheckout.Request(this.savePaymentMethodUrl,{method:"post",parameters:i})}},validateElement:function(e){var t=!0;return Form.getElements(e).each(function(e){var i=$w(e.className);t=t&&i.all(function(t){var i=Validation.get(t),s=!0;try{s=Validation.isVisible(e)&&!i.test($F(e),e)?!1:!0}catch(o){s=!0}return s})}),t}},MagecheckoutSecuredCheckoutReviewCart=Class.create(),MagecheckoutSecuredCheckoutReviewCart.prototype={initialize:function(e){this.removeProductLinks=$$(e.removeProductLinks),this.removeProductConfirmMessage=e.removeProductConfirmMessage,this.plusProductLinks=$$(e.plusProductLinks),this.minusProductLinks=$$(e.minusProductLinks),this.ajaxCartItemUrl=e.ajaxCartItemUrl,this.initObserver()},initObserver:function(){this.removeProductLinks.each(function(e){e.observe("click",function(e){this.onClickRemoveProductLink(e)}.bind(this))}.bind(this)),this.plusProductLinks.each(function(e){e.observe("click",function(e){this.onClickPlusProductLink(e)}.bind(this))}.bind(this)),this.minusProductLinks.each(function(e){e.observe("click",function(e){this.onClickMinusProductLink(e)}.bind(this))}.bind(this))},onClickMinusProductLink:function(e){var t=e.target.id;this._processCartItem("minus",t),e.stop},onClickPlusProductLink:function(e){var t=e.target.id;this._processCartItem("plus",t),e.stop},onClickRemoveProductLink:function(e){if(!confirm(this.removeProductConfirmMessage))return!1;var t=e.target.id;this._processCartItem("remove",t),e.stop()},_processCartItem:function(e,t){var i={method:"post",parameters:{action:e,id:t},onComplete:function(e){try{var t=e.responseText.evalJSON();!t.success&&t.error&&alert(t.error)}catch(i){}}};MagecheckoutSecuredCheckout.Request(this.ajaxCartItemUrl,i)}},MagecheckoutSecuredCheckoutReviewCoupon=Class.create(),MagecheckoutSecuredCheckoutReviewCoupon.prototype={initialize:function(e){this.couponContainer=$$(e.couponContainer).first(),this.couponInput=$(e.couponInput),this.applyCouponUrl=e.applyCouponUrl,this.isAppliedCoupon=e.isAppliedCoupon,this.showApplyButton=e.showApplyButton,this.applyCouponButton=$$(e.applyCouponButton).first(),this.cancelCouponButton=$$(e.cancelCouponButton).first(),this.messageContainer=$$(e.messageContainer).first(),this.errorClass=e.errorClass,this.successClass=e.successClass,this.initObserver()},initObserver:function(){this.showApplyButton?this.applyCouponButton&&(this.applyCouponButton.observe("click",function(){this.processCoupon()}.bind(this)),this.cancelCouponButton.observe("click",function(){this.processCoupon()}.bind(this))):this.couponInput&&this.couponInput.observe("change",function(){this.processCoupon()}.bind(this))},processCoupon:function(){var e=this.couponContainer;if(e.select(".validation-advice").each(function(e){e.remove()}),this._removeAllMessage(),this.showApplyButton)if(this.isAppliedCoupon)this.couponInput.setValue("");else{this.couponInput.addClassName("required-entry");var t=Validation.validate(this.couponInput);if(this.couponInput.removeClassName("required-entry"),!t)return!1}else if(!this.couponInput.getValue()&&!this.isAppliedCoupon)return!1;var i=this.messageContainer,s=this.successClass,o=this.errorClass,n=this,r={method:"post",parameters:{coupon_code:this.couponInput.getValue()},onComplete:function(e){try{var t=e.responseText.evalJSON();n.isAppliedCoupon=t.coupon_applied,t.success===!0?MagecheckoutSecuredCheckout.showMessage(i,t.messages,s):t.messages&&MagecheckoutSecuredCheckout.showMessage(i,t.messages,o)}catch(r){}n.isAppliedCoupon?(n.applyCouponButton.hide(),n.cancelCouponButton.show()):(n.applyCouponButton.show(),n.cancelCouponButton.hide());var c=MagecheckoutSecuredCheckout.getHeightFromElement(i);MagecheckoutSecuredCheckout.applyMorphEffect(i,c,.3,function(){i.setStyle({display:""})})}};MagecheckoutSecuredCheckout.Request(this.applyCouponUrl,r)},_removeAllMessage:function(){MagecheckoutSecuredCheckout.removeMessage(this.couponContainer,this.errorClass),MagecheckoutSecuredCheckout.removeMessage(this.couponContainer,this.successClass),MagecheckoutSecuredCheckout.applyMorphEffect(this.messageContainer,0,.5,function(){this.messageContainer.setStyle({display:"none"})}.bind(this))}},MagecheckoutSecuredCheckoutReviewComment=Class.create(),MagecheckoutSecuredCheckoutReviewComment.prototype={initialize:function(e){var e=e||{};this.useEffect=e.useEffect||!1,this.commentContainer=e.commentContainer?e.commentContainer:".one-step-checkout-review-comments",this.commentContainerEl=$$(this.commentContainer).first(),this.newRowCount=e.newRowCount||5,this.commentContainerEl.select("textarea").each(function(e){e.setStyle({"overflow-y":"hidden"}),this.textAreaEffectObserver(e)}.bind(this)),Form.getElements(this.commentContainerEl).each(function(e){e.observe("change",function(){this.saveFormData()}.bind(this))}.bind(this))},saveFormData:function(){MagecheckoutSecuredCheckout.saveFormData(this.commentContainerEl)},textAreaEffectObserver:function(e){if(!this.useEffect)return!1;var t=e.scrollHeight,i=parseInt(e.getAttribute("rows")),s=parseInt(e.getStyle("height"));this._focusEffect(e,t,i,s),this._blurEffect(e,t,i,s)},_focusEffect:function(e,t,i,s){e.observe("focus",function(){var o=i+(e.scrollHeight-t)*i/s;o<this.newRowCount?o=this.newRowCount:o++;var n=s/i*o;this.rowsAttributeEffect(e,o,n,function(){e.setStyle({"overflow-y":"auto"})})}.bind(this))},_blurEffect:function(e,t,i,s){e.observe("blur",function(){var t=e.getValue().strip().length;if(0===t)this.scrollTextareaEffect(e,function(){e.setStyle({"overflow-y":"hidden"}),this.rowsAttributeEffect(e,i,s)}.bind(this));else{var o=s/i*this.newRowCount;this.scrollTextareaEffect(e,function(){e.setStyle({"overflow-y":"hidden"}),this.rowsAttributeEffect(e,this.newRowCount,o)}.bind(this))}}.bind(this))},rowsAttributeEffect:function(e,t,i,s){e.effect&&e.effect.cancel(),this._textAraEffect(e,t,i,s)},scrollTextareaEffect:function(e,t){var i=e.effect;i&&i.cancel(),this._scrollEffect(e,t)},_textAraEffect:function(e,t,i,s){var s=s||new Function;e.effect=new Effect.Morph(e,{style:{height:i+"px"},duration:.5,afterFinish:function(){e.setAttribute("rows",t),delete e.effect,s()}})},_scrollEffect:function(e,t){var t=t||new Function;return 0===e.scrollTop?void t():void new Effect.Tween(e,e.scrollTop,0,{duration:.5,afterFinish:function(){t()}},"scrollTop")}},MagecheckoutSecuredCheckoutReviewGiftmessage=Class.create(),MagecheckoutSecuredCheckoutReviewGiftmessage.prototype={initialize:function(e){this.giftMessageContainer=$$(e.giftMessageContainer).first(),this.giftMessageForm=$$(e.giftMessageForm).first(),this.useGiftmessageCheckbox=$$(e.useGiftmessageCheckbox).first(),this.isUsedGiftMessage=$$(e.isUsedGiftMessage).first(),this.inputElementIds=e.inputElementIds,this.initGiftMessage(),this.initObserver()},initGiftMessage:function(){this.useGiftmessageCheckbox&&this.processGiftMessage(this.useGiftmessageCheckbox)},initObserver:function(){this.useGiftmessageCheckbox&&this.useGiftmessageCheckbox.observe("change",function(e){this.processGiftMessage(e)}.bind(this)),this.inputElementIds.each(function(e){var t=$(e);t&&t.observe("change",function(){this.saveFormData()}.bind(this))}.bind(this))},saveFormData:function(){MagecheckoutSecuredCheckout.saveFormData(this.giftMessageContainer)},processGiftMessage:function(e){if("object"==typeof e){var t;t=e.target?e.target:e,t.checked?(this.isUsedGiftMessage.value=1,this.showGiftMessage()):(this.isUsedGiftMessage.value=0,this.hideGiftMessage()),this.saveFormData()}},showGiftMessage:function(){var e=this.giftMessageForm;e.setStyle({display:""});var t=MagecheckoutSecuredCheckout.getHeightFromElement(this.giftMessageForm);MagecheckoutSecuredCheckout.applyMorphEffect(this.giftMessageForm,t,.3,function(){e.setStyle({height:""})})},hideGiftMessage:function(){var e=this.giftMessageForm;MagecheckoutSecuredCheckout.applyMorphEffect(this.giftMessageForm,0,.5,function(){e.setStyle({display:"none"})}),this.clearInput()},clearInput:function(){this.inputElementIds.each(function(e){$(e)&&$(e).setValue("")})}},MagecheckoutSecuredCheckoutReviewGiftwrap=Class.create(),MagecheckoutSecuredCheckoutReviewGiftwrap.prototype={initialize:function(e){this.useGiftWrapCheckbox=$$(e.useGiftWrapCheckbox).first(),this.addGiftWrapUrl=e.addGiftWrapUrl,this.initObserver()},initObserver:function(){this.useGiftWrapCheckbox&&this.useGiftWrapCheckbox.observe("change",this.applyGiftWrap.bind(this))},applyGiftWrap:function(){var e={method:"post",parameters:{is_used_giftwrap:this.useGiftWrapCheckbox.getValue()}};MagecheckoutSecuredCheckout.Request(this.addGiftWrapUrl,e)}},MagecheckoutSecuredCheckoutReviewDelivery=Class.create(),MagecheckoutSecuredCheckoutReviewDelivery.prototype={initialize:function(e){this.deliveryContainer=$$(e.deliveryContainer).first(),this.deliveryWrapper=$$(e.deliveryWrapper).first(),this.useDeliveryCheckbox=$$(e.useDeliveryCheckbox).first(),this.isUsedDeliveryTime=$$(e.isUsedDeliveryTime).first(),this.initDelivery(),this.initObserve()
},initDelivery:function(){this.handleDelivery()},initObserve:function(){this.useDeliveryCheckbox.observe("change",function(){this.handleDelivery(),this.saveFormData()}.bind(this))},handleDelivery:function(){this.useDeliveryCheckbox.getValue()?(this.isUsedDeliveryTime.value=1,this.showDelivery()):(this.isUsedDeliveryTime.value=0,this.hideDelivery())},saveFormData:function(){MagecheckoutSecuredCheckout.saveFormData(this.deliveryContainer)},showDelivery:function(){var e=this,t=MagecheckoutSecuredCheckout.getHeightFromElement(this.deliveryWrapper);this.deliveryWrapper.setStyle({display:""}),MagecheckoutSecuredCheckout.applyMorphEffect(this.deliveryWrapper,t,.3,function(){e.deliveryWrapper.setStyle({height:""})})},hideDelivery:function(){var e=this;MagecheckoutSecuredCheckout.applyMorphEffect(e.deliveryWrapper,0,.5,function(){e.deliveryWrapper.setStyle({display:"none"})})}},MagecheckoutSecuredCheckoutReviewTerms=Class.create(),MagecheckoutSecuredCheckoutReviewTerms.prototype={initialize:function(e){this.termContainer=$$(e.termContainer).first(),this.termItemElements=$$(e.termItemElements),this.linkFromItem=e.linkFromItem,this.checkboxFromItem=e.checkboxFromItem,this.checkedFromItem=e.checkedFromItem,this.acceptTermItem=e.acceptTermItem,this.descriptionContainerFromItem=e.descriptionContainerFromItem,this.isRequiredReadTerm=e.isRequiredReadTerm,this.readTermMessage=e.readTermMessage,this.errorClass=e.errorClass,this.popup={},this.initObserver()},initObserver:function(){this.termItemElements.each(function(e){var t=e.select(this.linkFromItem).first(),i=e.select(this.checkboxFromItem).first(),s=e.select(this.checkedFromItem).first(),o=e.select(this.acceptTermItem).first(),n=e.select(this.descriptionContainerFromItem).first(),r=!t||!n;if(!r){var c=t.id;i&&(i.checked=1==s.value?!0:!1,i.observe("click",function(e){this._removeAllMessage(),this.isRequiredReadTerm&&0==s.value&&(e.target.checked=!1,MagecheckoutSecuredCheckout.showMessage(this.termContainer,this.readTermMessage,this.errorClass)),s.value=e.target.checked?1:0,this.saveFormData()}.bind(this))),this.popup[c]=new MagecheckoutSecuredCheckoutPopup({selector:"#"+c,tinyBoxConfig:{html:n}}),o&&o.observe("click",function(){i.checked=!0,s.value=1,this._removeAllMessage(),this.popup[c].hidePopup(),this.saveFormData()}.bind(this))}}.bind(this))},_removeAllMessage:function(){this.termContainer.select(".validation-advice").each(function(e){e.remove()}),MagecheckoutSecuredCheckout.removeMessage(this.termContainer,this.errorClass)},saveFormData:function(){MagecheckoutSecuredCheckout.saveFormData(this.termContainer)}},MagecheckoutSecuredCheckoutForm=Class.create(),MagecheckoutSecuredCheckoutForm.prototype={initialize:function(e){this.checkoutForm=new VarienForm(e.checkoutForm),this.shippingMethodWrapper=e.shippingMethodWrapper,this.shippingMethodInput=e.shippingMethodInput,this.shippingMethodAdvice=e.shippingMethodAdvice,this.shippingValidationMessage=e.shippingValidationMessage,this.paymentMethodWrapper=e.paymentMethodWrapper,this.paymentMethodInput=e.paymentMethodInput,this.paymentMethodAdvice=e.paymentMethodAdvice,this.paymentValidationMessage=e.paymentValidationMessage,this.reviewCartContainer=$$(e.reviewCartContainer).first(),this.placeOrderButton=$(e.placeOrderButton),this.placeOrderUrl=e.placeOrderUrl,this.successUrl=e.successUrl,this.placeOrderButton=$(e.placeOrderButton),this.showGrandTotalAmount=e.showGrandTotalAmount,this.grandTotalAmount=this.placeOrderButton.select(e.grandTotalAmount).first(),this.grandTotalAmountProcess=this.placeOrderButton.select(e.grandTotalAmountProcess).first(),this.pleaseWaitNotice=$$(e.pleaseWaitNotice).first(),this.disabledClassName=e.disabledClassName,this.overlayClassName=e.overlayClassName,Event.fire(document,"magecheckout:form_init_before",{form:this}),this.initObserver(),Event.fire(document,"magecheckout:form_init_after",{form:this})},initObserver:function(){this.placeOrderButton&&this.placeOrderButton.observe("click",function(){this.placeOrderProcess()}.bind(this))},placeOrderProcess:function(){this.validate()&&(MagecheckoutSecuredCheckout.addOverlay(document.body,this.overlayClassName),this.showPleaseWait(),this.disablePlaceOrderButton(),this._placeOrderRequest())},_placeOrderRequest:function(){var e=Form.serialize(this.checkoutForm.form,!0),t={method:"post",parameters:e,onComplete:function(e){this.placeOrderComplete(e)}.bind(this)};new Ajax.Request(this.placeOrderUrl,t)},evalToJson:function(e){try{e=e.evalJSON()}catch(t){e={}}return e},placeOrderComplete:function(transport){if(transport&&transport.responseText){var response=transport.responseText;if(response=this.evalToJson(response),Event.fire(window,"magecheckout:one_step_checkout_place_order_complete",{object:this,res:response}),response.isProcess)return;var redirect=response.redirect;if(redirect)return void setLocation(redirect);var success=response.success;if(1==success){var successUrl=this.successUrl;setLocation(successUrl)}else if(this.isHostedPro(response)){var popup=new MagecheckoutSecuredCheckoutPopup({selector:"",tinyBoxConfig:{html:response.update_section.html,top:30,height:300,width:450,boxid:"popup_is_hosted_pro",closejs:function(){window.location.reload()},openjs:function(){var e=$("hss-iframe"),t=$("iframe-warning");t.show(),e.show()}}});popup.showPopup();var iframe=$("popup_is_hosted_pro").select("#hss-iframe").first();iframe.observe("dom:loaded",function(){var e=$("hss-iframe"),t=$("iframe-warning");t.show(),e.show()})}else if("is_centinel"in response&&response.is_centinel){var popup=new MagecheckoutSecuredCheckoutPopup({selector:"",tinyBoxConfig:{html:response.update_section.html,top:30,height:300,width:400,boxid:"popup_is_3d_secure",closejs:function(){window.location.reload()},openjs:function(){for(var arr=$("popup_is_3d_secure").getElementsByTagName("script"),n=0;n<arr.length;n++)eval(arr[n].innerHTML)}}});popup.showPopup()}else{var message=response.messages;"object"==typeof message&&(message=message.join("\n")),message&&alert(message)}this.enablePlaceOrder()}},isHostedPro:function(e){return"is_hosted_pro"in e&&e.is_hosted_pro},enablePlaceOrder:function(){this.hidePleaseWait(),this.enablePlaceOrderButton(),MagecheckoutSecuredCheckout.removeOverlay(document.body,this.overlayClassName)},showPleaseWait:function(){this.pleaseWaitNotice.show(),new Effect.Morph(this.pleaseWaitNotice,{style:{marginTop:"10px"},duration:.2})},hidePleaseWait:function(){this.pleaseWaitNotice.hide()},disablePlaceOrderButton:function(){this.placeOrderButton.addClassName(this.disabledClassName),this.placeOrderButton.disabled=!0},enablePlaceOrderButton:function(){this.placeOrderButton.removeClassName(this.disabledClassName),this.placeOrderButton.disabled=!1},_validateShippingMethod:function(e){var t=$$(this.shippingMethodWrapper).first(),i=$$(this.shippingMethodAdvice).first(),s=!0;if(t&&i){var o=e[this.shippingMethodInput];o?(t.removeClassName("validation-failed"),i.update("").hide(),s=!0):(t.addClassName("validation-failed"),i.update(this.shippingValidationMessage).show(),s=!1)}return s},_validatePaymentMethod:function(e){var t=$$(this.paymentMethodWrapper).first(),i=$$(this.paymentMethodAdvice).first(),s=!0;if(t&&i){var o=e[this.paymentMethodInput];o?(t.removeClassName("validation-failed"),i.update("").hide(),s=!0):(t.addClassName("validation-failed"),i.update(this.paymentValidationMessage).show(),s=!1)}return s},validate:function(){var e=Form.serialize(this.checkoutForm.form,!0),t=this.checkoutForm.validator.validate(),i=this._validateShippingMethod(e),s=$$(this.shippingMethodWrapper).first(),o=this._validatePaymentMethod(e),n=$$(this.paymentMethodWrapper).first();return t&&(i?o||n.scrollTo():s.scrollTo()),t&&i&&o}},MagecheckoutSecuredCheckoutCompareWishlist=Class.create(),MagecheckoutSecuredCheckoutCompareWishlist.prototype={initialize:function(e){this.addToContainer=$$(e.addToContainer).first(),this.addToCompareLinks=$$(e.addToCompareLinks),this.addToWishlistLinks=$$(e.addToWishlistLinks),this.productImageClass=e.productImageClass,this.addToCompareUrl=e.addToCompareUrl,this.addToWishlistUrl=e.addToWishlistUrl,this.initObserver()},initObserver:function(){this.addToCompareLinks.each(function(e){e.observe("click",function(e){this._processCompareWishlist(e,"compare")}.bind(this))}.bind(this)),this.addToWishlistLinks.each(function(e){e.observe("click",function(e){this._processCompareWishlist(e,"wishlist")}.bind(this))}.bind(this))},_processCompareWishlist:function(e,t){if("compare"==t)var i=e.target.id.split("product-compare-")[1],s=this.addToCompareUrl;else var i=e.target.id.split("product-wishlist-")[1],s=this.addToWishlistUrl;var o={method:"post",parameters:{product:i},onComplete:function(t){try{var i=t.responseText.evalJSON();e.target.up().update(i.success?i.message:i.error)}catch(s){}}};MagecheckoutSecuredCheckout.Request(s,o)}};